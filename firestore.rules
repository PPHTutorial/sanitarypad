rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

  // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

  // Helper function to check if user owns the resource
    function isResourceOwner() {
      return request.auth != null && resource.data.userId == request.auth.uid;
    }

  // Helper function to check if user owns the new resource
    function isNewResourceOwner() {
      return request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Check if user has specific subscription tier
    function hasTier(tiers) {
      return request.auth != null && 
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscription.tier in tiers;
    }

    // Helper to check group membership using deterministic member document IDs
    function isGroupMember(groupId) {
      return request.auth != null && (
      exists(/databases/$(database)/documents/groupMembers/$(groupId + '_' + request.auth.uid)) ||
      (exists(/databases/$(database)/documents/groups/$(groupId)) &&
      get(/databases/$(database)/documents/groups/$(groupId)).data.adminId == request.auth.uid)
      );
    }

    function isGroupAdmin(groupId) {
      return request.auth != null &&
      exists(/databases/$(database)/documents/groups/$(groupId)) &&
      get(/databases/$(database)/documents/groups/$(groupId)).data.adminId == request.auth.uid;
    }

    // Helper to check if user is an admin
    function isAdmin() {
      return request.auth != null && 
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if request.auth != null && (
      isOwner(userId) || 
      isAdmin() ||
      resource.data.privacy.profileVisibility == 'public' ||
      (resource.data.privacy.profileVisibility == 'protected' && request.auth != null)
      );
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId);
    }

    // ============================================
    // CYCLES COLLECTION
    // ============================================
    match /cycles/{cycleId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // CYCLE PREDICTIONS COLLECTION
    // ============================================
    match /cyclePredictions/{predictionId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // SYMPTOMS COLLECTION
    // ============================================
    match /symptoms/{symptomId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // WELLNESS ENTRIES COLLECTION
    // ============================================
    match /wellnessEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // PADS COLLECTION
    // ============================================
    match /pads/{padId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // PAD INVENTORY COLLECTION
    // ============================================
    match /padInventory/{inventoryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // REMINDERS COLLECTION
    // ============================================
    match /reminders/{reminderId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // WELLNESS CONTENT COLLECTION (Public Read, Authenticated Write)
    // ============================================
    match /wellnessContent/{contentId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    match /analytics/{analyticsId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // SUBSCRIPTIONS COLLECTION
    // ============================================
    match /subscriptions/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false; // Keep audit trail
    }

    // ============================================
    // SUPPORT CONTACTS COLLECTION
    // ============================================
    match /supportContacts/{contactId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // RED FLAG ALERTS COLLECTION
    // ============================================
    match /redFlagAlerts/{alertId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if false; // Keep records
    }

    // ============================================
    // PREGNANCIES COLLECTION
    // ============================================
    match /pregnancies/{pregnancyId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // PREGNANCY ENHANCED COLLECTIONS
    // ============================================
    match /kickEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /contractionEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /pregnancyAppointments/{appointmentId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /pregnancyMedications/{medicationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /pregnancyJournalEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /pregnancyWeightEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /hospitalChecklistItems/{itemId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // FERTILITY ENTRIES COLLECTION
    // ============================================
    match /fertilityEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // FERTILITY ENHANCED COLLECTIONS
    // ============================================
    match /hormoneCycles/{cycleId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /fertilitySymptoms/{symptomId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /moodEnergyEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /fertilityMedications/{medicationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /intercourseEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /pregnancyTestEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /healthRecommendations/{recommendationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /ovulationTestReminders/{reminderId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // SKINCARE ENTRIES COLLECTION
    // ============================================
    match /skincareEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // SKINCARE PRODUCTS COLLECTION
    // ============================================
    match /skincareProducts/{productId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // SKINCARE ENHANCED COLLECTIONS
    // ============================================
    match /skinTypes/{typeId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /skinJournalEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /routineTemplates/{templateId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /ingredients/{ingredientId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Only allow admins to update/delete globally shared ingredients
      // For now, allowing update for persistence but restricting delete
      allow update: if request.auth != null;
      allow delete: if false; 
    }

    match /acneEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /uvIndexEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /skinGoals/{goalId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // COMMUNITY COLLECTIONS (GROUPS & EVENTS)
    // ============================================
    match /groups/{groupId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null; // All authenticated users can read groups
      allow create: if request.auth != null; // Any authenticated user can create groups
      allow update: if request.auth != null && 
      (resource.data.adminId == request.auth.uid ||
      resource.data.createdBy == request.auth.uid ||
      request.resource.data.adminId == request.auth.uid);
      allow delete: if request.auth != null &&
      (resource.data.adminId == request.auth.uid || resource.data.createdBy == request.auth.uid);
    }

    match /groupMembers/{memberId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /groupMessages/{messageId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null && isGroupMember(resource.data.groupId);
      allow create: if request.auth != null && isGroupMember(request.resource.data.groupId);
      allow update: if request.auth != null && (
      resource.data.senderId == request.auth.uid ||
      isGroupAdmin(resource.data.groupId)
      );
      allow delete: if request.auth != null && (
      resource.data.senderId == request.auth.uid ||
      isGroupAdmin(resource.data.groupId)
      );
    }

    match /events/{eventId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null; // All authenticated users can read events
      allow create: if request.auth != null; // Any authenticated user can create events
      allow update: if request.auth != null && 
      (resource.data.organizerId == request.auth.uid || request.resource.data.organizerId == request.auth.uid);
      allow delete: if request.auth != null && resource.data.organizerId == request.auth.uid;
    }

    match /eventAttendees/{attendeeId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // ============================================
    // AI CHAT COLLECTIONS
    // ============================================
    match /aiChatMessages/{messageId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    match /aiConversations/{conversationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }

    // ============================================
    // TRANSACTIONS COLLECTION (Credit History)
    // ============================================
    match /transactions/{transactionId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner() || isAdmin(); 
      allow create: if isNewResourceOwner();
      allow update: if false; 
      allow delete: if false;
    }

    // ============================================
    // SUPPORT TICKETS COLLECTION
    // ============================================
    match /support_tickets/{ticketId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && (
      isResourceOwner() || isAdmin() || (request.resource != null && request.resource.data.userId == request.auth.uid)
      );
      allow delete: if false; // Keep for audit
    }

    // ============================================
    // APP CONFIG COLLECTION
    // ============================================
    match /app_config/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admins via console
    }

    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
