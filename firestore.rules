rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if user owns the resource
    function isResourceOwner() {
      return request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Helper function to check if user owns the new resource
    function isNewResourceOwner() {
      return request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // CYCLES COLLECTION
    // ============================================
    match /cycles/{cycleId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // CYCLE PREDICTIONS COLLECTION
    // ============================================
    match /cyclePredictions/{predictionId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // SYMPTOMS COLLECTION
    // ============================================
    match /symptoms/{symptomId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // WELLNESS ENTRIES COLLECTION
    // ============================================
    match /wellnessEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // PADS COLLECTION
    // ============================================
    match /pads/{padId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // PAD INVENTORY COLLECTION
    // ============================================
    match /padInventory/{inventoryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // REMINDERS COLLECTION
    // ============================================
    match /reminders/{reminderId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // WELLNESS CONTENT COLLECTION (Public Read, Authenticated Write)
    // ============================================
    match /wellnessContent/{contentId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    match /analytics/{analyticsId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // SUBSCRIPTIONS COLLECTION
    // ============================================
    match /subscriptions/{subscriptionId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if false; // Keep audit trail
    }
    
    // ============================================
    // SUPPORT CONTACTS COLLECTION
    // ============================================
    match /supportContacts/{contactId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // RED FLAG ALERTS COLLECTION
    // ============================================
    match /redFlagAlerts/{alertId} {
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if false; // Keep records
    }
    
    // ============================================
    // PREGNANCIES COLLECTION
    // ============================================
    match /pregnancies/{pregnancyId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // PREGNANCY ENHANCED COLLECTIONS
    // ============================================
    match /kickEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /contractionEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /pregnancyAppointments/{appointmentId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /pregnancyMedications/{medicationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /pregnancyJournalEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /pregnancyWeightEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /hospitalChecklistItems/{itemId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // FERTILITY ENTRIES COLLECTION
    // ============================================
    match /fertilityEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // FERTILITY ENHANCED COLLECTIONS
    // ============================================
    match /hormoneCycles/{cycleId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /fertilitySymptoms/{symptomId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /moodEnergyEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /fertilityMedications/{medicationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /intercourseEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /pregnancyTestEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /healthRecommendations/{recommendationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /ovulationTestReminders/{reminderId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // SKINCARE ENTRIES COLLECTION
    // ============================================
    match /skincareEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // SKINCARE PRODUCTS COLLECTION
    // ============================================
    match /skincareProducts/{productId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // SKINCARE ENHANCED COLLECTIONS
    // ============================================
    match /skinTypes/{typeId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /skinJournalEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /routineTemplates/{templateId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /ingredients/{ingredientId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null; // Ingredients can be shared/read by all authenticated users
      allow create: if request.auth != null; // Any authenticated user can add ingredients
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    match /acneEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /uvIndexEntries/{entryId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /skinGoals/{goalId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // COMMUNITY COLLECTIONS (GROUPS & EVENTS)
    // ============================================
    match /groups/{groupId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null; // All authenticated users can read groups
      allow create: if request.auth != null; // Any authenticated user can create groups
      allow update: if request.auth != null && 
        (resource.data.adminId == request.auth.uid || request.resource.data.adminId == request.auth.uid);
      allow delete: if request.auth != null && resource.data.adminId == request.auth.uid;
    }
    
    match /groupMembers/{memberId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    match /events/{eventId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null; // All authenticated users can read events
      allow create: if request.auth != null; // Any authenticated user can create events
      allow update: if request.auth != null && 
        (resource.data.organizerId == request.auth.uid || request.resource.data.organizerId == request.auth.uid);
      allow delete: if request.auth != null && resource.data.organizerId == request.auth.uid;
    }
    
    match /eventAttendees/{attendeeId} {
      allow list: if request.auth != null;
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ============================================
    // AI CHAT COLLECTIONS
    // ============================================
    match /aiChatMessages/{messageId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    match /aiConversations/{conversationId} {
      allow list: if request.auth != null;
      allow read: if isResourceOwner();
      allow create: if isNewResourceOwner();
      allow update: if isResourceOwner();
      allow delete: if isResourceOwner();
    }
    
    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
